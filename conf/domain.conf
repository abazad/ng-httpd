server {
	set $root	DOCROOT;
	set $iport	PORT;
	set $eport	80;
	if ($scheme = https) {
		set $root	DOCROOT_SSL;
		set $iport	PORT_SSL;
		set $eport	443;
	}

	LISTEN
	server_name	.DOMAIN ALIAS;
	root		$root;
	access_log	/var/log/httpd/domains/DOMLOG.bytes bytes;
	access_log	/var/log/httpd/domains/DOMLOG.log domain;
	SSL

	location / {
		PROXY
		proxy_set_header Host			$host:$eport;
		proxy_set_header X-Real-IP		$remote_addr;
		proxy_set_header X-Forwarded-For	$proxy_add_x_forwarded_for;

		if (-d $request_filename) {
			rewrite ^(.*[^/])$ $1/ permanent;
		}
	}
	location ~ /\.ht {
		deny all;
	}
	# Special location for case insensitive phpmyadmin
	location ~* ^/phpmyadmin/(.+\.(gif|jpe?g|png|ico|svg|css|js|htc|swf|txt|pdf|rtf|docx?|xlsx?|zip|rar|iso))$ {
		alias		/var/www/html/phpMyAdmin/$1;
		expires		24h;
		log_not_found	off;
	}
	location ~* ^/(webmail|squirrelmail|roundcube)/.+\.(gif|jpe?g|png|ico|svg|css|js|htc|swf|txt|pdf|rtf|docx?|xlsx?|zip|rar|iso)$ {
		root		/var/www/html;
		expires		24h;
		log_not_found	off;
	}
	location ~* \.(gif|jpe?g|png|ico|svg|css|js|htc|swf|txt|pdf|rtf|docx?|xlsx?|zip|rar|iso)$ {
		expires		24h;
		log_not_found	off;
	}
	# Allow PHP for standard applications
	location ~* ^/(webmail|squirrelmail|roundcube|phpmyadmin) {
		proxy_pass http://ADDR:$iport;
		proxy_set_header Host			$host:$eport;
		proxy_set_header X-Real-IP		$remote_addr;
		proxy_set_header X-Forwarded-For	$proxy_add_x_forwarded_for;

		root /var/www/html;
		if (-d $request_filename) {
			rewrite ^(.*[^/])$ $1/ permanent;
		}
	}
}
